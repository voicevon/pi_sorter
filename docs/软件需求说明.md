# 芦笋分拣机软件需求文档

## 1. 产品概述
智能芦笋分拣系统，基于计算机视觉和机器学习的自动化分拣设备。

**目标用户**: 芦笋种植基地、农产品加工企业、蔬菜批发市场

## 2. 核心目标
- 处理速度：30-60根/分钟
- 分拣准确率：≥90%
- 连续工作：≥20小时
- 成本降低：60%以上

## 3. 系统流程框架

### 3.1 整体流程概述
系统采用四步式处理流程，实现从图像采集到机械分拣的完整自动化：

```
步骤1: 图像采集 → 步骤2: 图像传输与预处理 → 步骤3: 特征分析与分类 → 步骤4: 机械控制与分拣
```

### 3.2 详细流程设计

#### 步骤1: CSI摄像头图像采集
**功能描述**: 通过CSI接口摄像头实时拍摄芦笋照片
- **硬件**: CSI接口摄像头模块
- **采集频率**: 连续拍摄，处理间隔可配置（默认5秒）
- **图像格式**: RGB彩色图像，分辨率1280x1024
- **触发方式**: 
  - 定时触发：按设定间隔自动拍摄
  - 传感器触发：检测到芦笋进入拍摄区域
- **图像质量**: 自动曝光、白平衡调节

#### 步骤2: 图像传输与预处理
**功能描述**: 将拍摄的照片通过MQTT发送并进行预处理
- **数据传输**: 
  - 通过MQTT协议发送原始图像数据
  - 图像编码为Base64格式传输
  - 支持本地存储备份
- **预处理操作**:
  - 图像降噪和增强
  - 背景分割和目标提取
  - 图像标准化处理
- **数据格式**: JSON格式包含图像数据、时间戳、设备信息

#### 步骤3: 图像分析与特征提取
**功能描述**: 对芦笋进行深度图像分析和质量分类
- **特征提取**:
  - **几何特征**: 长度测量（±2mm精度）、直径测量（±1mm精度）
  - **形态特征**: 弯曲度计算（±2°精度）、笔直度评估
  - **表面特征**: 缺陷检测、颜色分析、纹理特征
  - **质量指标**: 新鲜度评估、成熟度判断
- **分类算法**:
  - 基于规则的多级分类系统
  - 支持3-5个质量等级（A级、B级、C级等）
  - 自定义分类标准配置
- **分类结果**: 输出分类等级、置信度、特征参数

#### 步骤4: 机械控制与分拣
**功能描述**: 根据分类结果控制机械分离机构进行自动分拣
- **控制信号**: 
  - 根据分类结果生成控制指令
  - 支持多路输出控制（对应不同出料仓）
  - 实时状态反馈和错误处理
- **机械动作**:
  - 气动推杆控制芦笋导向
  - 传送带速度调节
  - 分拣门开关控制
- **出料管理**:
  - 多个分级出料仓（A级仓、B级仓、C级仓、废料仓）
  - 出料计数和统计
  - 满仓检测和报警

## 4. 核心功能模块

### 4.1 图像采集模块
- 实时采集芦笋图像（≥30fps）
- CSI摄像头接口管理
- 图像预处理和背景分割
- 自动曝光和白平衡控制

### 4.2 通信传输模块
- MQTT协议图像传输
- 实时数据流管理
- 网络连接状态监控
- 数据压缩和编码

### 4.3 特征检测模块
- 长度、直径测量（精度±1mm）
- 弯曲度计算（精度±2°）
- 表面缺陷检测
- 颜色和纹理分析

### 4.4 质量分级模块
- 3-5个质量等级分类
- 分级准确率≥95%
- 支持自定义分类标准
- 置信度评估

### 4.5 机械控制模块
- 分拣机构控制
- 多路输出管理
- 实时状态监控
- 故障检测和处理

### 4.6 数据管理模块
- 分拣数据记录
- 统计报表生成
- 历史数据查询
- 性能分析

## 5. 技术架构

### 5.1 软件架构
系统采用分层架构设计，确保各模块职责清晰、耦合度低：

- **应用层**: 主控程序、用户界面、系统监控
- **业务逻辑层**: 图像处理、特征提取、质量分级、分拣控制
- **通信层**: MQTT消息传输、网络通信管理
- **硬件接口层**: CSI摄像头、GPIO控制、传感器接口
- **数据访问层**: 图像数据、配置数据、统计数据、日志管理

### 5.2 系统架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   主控程序   │  │   监控界面   │  │   配置管理   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                      业务逻辑层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   图像处理   │  │   特征提取   │  │   质量分级   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   分拣控制   │  │   数据统计   │  │   异常处理   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                       通信层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ MQTT客户端  │  │   消息队列   │  │   网络管理   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                     硬件接口层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ CSI摄像头   │  │  GPIO控制   │  │   传感器     │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                     数据访问层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   图像存储   │  │   配置文件   │  │   日志系统   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 核心技术栈
- **开发语言**: Python 3.8+
- **图像处理**: OpenCV 4.5+, NumPy
- **通信协议**: MQTT (paho-mqtt)
- **硬件接口**: 
  - CSI摄像头: picamera2库
  - GPIO控制: RPi.GPIO库
- **分类算法**: 基于特征的规则分类系统
- **数据存储**: 
  - 配置文件: YAML格式
  - 数据记录: CSV文件
  - 图像存储: JPEG格式
- **日志系统**: Python logging模块

### 5.4 数据流设计
```
CSI摄像头 → 图像采集模块 → 图像预处理 → MQTT传输
                                              ↓
机械控制 ← 分拣决策 ← 质量分级 ← 特征提取 ← 图像分析
    ↓
出料统计 → 数据记录 → 报表生成
```

## 6. 硬件要求

### 6.1 计算平台
- **主控**: Raspberry Pi 4B (8GB)
- **存储**: 128GB MicroSD卡
- **操作系统**: Raspberry Pi OS
- **网络**: WiFi/以太网连接

### 6.2 图像采集系统
- **相机**: 全局快门相机，CSI接口
- **分辨率**: 1280x1024 @ 30fps
- **照明**: LED条形光源，可调亮度
- **镜头**: 固定焦距镜头，视野覆盖传送带宽度

### 6.3 机械控制系统
- **执行器**: 
  - 气动推杆 x 4（对应4个分级出料口）
  - 电磁阀控制模块
- **传感器**:
  - 光电传感器（检测芦笋进入）
  - 位置传感器（确认分拣动作）
  - 满仓检测传感器
- **控制接口**: 
  - GPIO扩展板
  - 继电器模块
  - PWM控制器

### 6.4 机械结构
- **传送带**: 变速传送带系统
- **分拣机构**: 多路分拣导向装置
- **出料仓**: 4个分级收集仓（A级、B级、C级、废料）
- **支撑结构**: 稳定的机械框架

## 7. 性能指标
- 处理速度：30-60根/分钟
- 分拣准确率：≥90%
- 测量精度：长度±2mm，直径±1mm
- 连续工作：≥20小时